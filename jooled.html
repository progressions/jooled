<html>
<head>
  <title>Jewels</title>
  
 <script src="javascripts/prototype.js" type="text/javascript"></script>
 <script src="javascripts/scriptaculous.js" type="text/javascript"></script>
 
<script type="text/javascript" charset="utf-8">

function pause(mills) {
  var date = new Date();
  var curDate = null;
  
  do {
    curDate = new Date();
  } while(curDate - date < mills);
};

function pixels(string) {
  string.match(/(\d*)px/);
  return parseInt(RegExp.$1);  
};

var Remove = {
  all: function(color) {
    $$('.jewel').each(function(j) {
      if (j.color() == color) {
        j.remove();
      }
    });
    Jewels.settle();
  }
};

var Explode = {
  single: function(element) {
    element = $(element);
    var row = element.row();
    var column = element.column();
    
    var elements = [];
    
    for (x=-1; x <= 1; x++) {
      for (y=-1; y <= 1; y++) {
        var jewel = Jewel.find(column+x, row+y);
        if (jewel) {
          jewel.remove();
        }
      }
    }
    setTimeout("Jewels.settle();", 300);
  }
};

var Pattern = {
  hint: function() {
    this.all(true);
  },
  
  all: function(highlight) {
    Pattern.highlight_on = highlight;
    
    var result = false;
    $$('.jewel').each(function(jewel) {
      result = result || Pattern.l(jewel) || Pattern.v(jewel) || Pattern.i(jewel);
    });
    if (!result) {
      alert("No moves!");
    }
    Pattern.highlight_on = false;
    return result;
  },
  
  match: function() {
    return Pattern.Match.all();
  },
  
  check: function(element, pattern) {
    return pattern.up(element) || pattern.down(element) || pattern.left(element) || pattern.right(element);
  },
  
  l: function(element) {
    return Pattern.check(element, Pattern.L);
  },
  
  v: function(element) {
    return Pattern.check(element, Pattern.V);
  },
  
  i: function(element) {
    return Pattern.check(element, Pattern.I);
  },
  
  five: function(element) {
    // return Pattern.check(element, Pattern.Match);
    var elements = [];
    elements.push(Pattern.Match.up(element));
    elements.push(Pattern.Match.down(element));
    elements.push(Pattern.Match.left(element));
    elements.push(Pattern.Match.right(element));
    elements.flatten();
    return elements;
  },
  
  solve: function(element, direction) {
    return true;
    element.move(direction);
    // alert("Solving pattern at " + element.column() + ", " + element.row());
    Jewels.checkAllForMatches();
    Pattern.all();
  },
  
  highlight_on: false,
  
  highlight: function(elements) {    
    if (Pattern.highlight_on) {
      elements.first().highlight();
      elements.first().setClicked();
    }
  },
  
  L: {
    all: function() {
      var result = false;
      $$('.jewel').each(function(jewel) {
        result = result || Pattern.l(jewel);
      });
      return result;
    },
  
    up: function(element) {
      return this.pattern(element, "up", "left") || this.pattern(element, "up", "right");
    },
  
    down: function(element) {
      return this.pattern(element, "down", "left") || this.pattern(element, "down", "right");
    },
  
    left: function(element) {
      return this.pattern(element, "left", "up") || this.pattern(element, "left", "down");
    },
  
    right: function(element) {
      return this.pattern(element, "right", "up") || this.pattern(element, "right", "down");
    },
  
    pattern: function(element, pointing, side) {
      var x_direction, y_direction;
    
      if (pointing == "up" || side == "up") {
        y_direction = -1;
      }
      if (pointing == "down" || side == "down") {
        y_direction = 1;
      }
      if (pointing == "left" || side == "left") {
        x_direction = -1;
      }
      if (pointing == "right" || side == "right") {
        x_direction = 1;
      }
    
      element = $(element);
    
      var color = element.color();
      var col = element.column();
      var row = element.row();
    
      var result = false;
    
      var x,y;
      x = col + (x_direction);
      y = row + (y_direction);
      first = Jewel.find(x,y);
      if (first && first.color() == color) {
        if (pointing == "up" || pointing == "down") {
          y = row + (2 * y_direction);
        }
        if (pointing == "left" || pointing == "right") {
          x = col + (2 * x_direction);
        }
        second = Jewel.find(x,y);
        result = result || second && second.color() == color;
        if (result) {
          Pattern.highlight([element, first, second]);
          Pattern.solve(element, side);
          return result;
        }  
      }    
    }
  },
  
  V: {
    all: function() {
      var result = false;
      $$('.jewel').each(function(jewel) {
        result = result || Pattern.v(jewel)
      });
      return result;
    },
  
    up: function(element) {
      return this.pattern(element, "up");
    },
  
    down: function(element) {
      return this.pattern(element, "down");
    },
  
    left: function(element) {
      return this.pattern(element, "left");
    },
  
    right: function(element) {
      return this.pattern(element, "right");
    },
  
    pattern: function(element, pointing) {
      var x_direction = -1;
      var y_direction = -1;
    
      if (pointing == "up") {
        y_direction = -1;
      }
      if (pointing == "down") {
        y_direction = 1;
      }
      if (pointing == "left") {
        x_direction = -1;
      }
      if (pointing == "right") {
        x_direction = 1;
      }
          
      element = $(element);
    
      var color = element.color();
      var col = element.column();
      var row = element.row();
    
      var result = false;
    
      var x,y;
      x = col + (x_direction);
      y = row + (y_direction);
      first = Jewel.find(x,y);
      if (first && first.color() == color) {
        if (pointing == "up" || pointing == "down") {
          x = col - (x_direction);
          y = row + (y_direction);
        }
        if (pointing == "left" || pointing == "right") {
          x = col + (x_direction);
          y = row - (y_direction);
        }
        second = Jewel.find(x,y);
        result = result || second && second.color() == color;
        if (result) {
          Pattern.highlight([element, first, second]);
          Pattern.solve(element, pointing);
          return result;
        }  
      }    
    }
  },
  
  I: {
    all: function() {
      var result = false;
      $$('.jewel').each(function(jewel) {
        result = result || Pattern.i(jewel);
      });
      return result;
    },
  
    up: function(element) {
      return this.pattern(element, "up");
    },
  
    down: function(element) {
      return this.pattern(element, "down");
    },
  
    left: function(element) {
      return this.pattern(element, "left");
    },
  
    right: function(element) {
      return this.pattern(element, "right");
    },
  
    pattern: function(element, pointing) {
      var x_direction = 0;
      var y_direction = 0;
    
      if (pointing == "up") {
        y_direction = -1;
      }
      if (pointing == "down") {
        y_direction = 1;
      }
      if (pointing == "left") {
        x_direction = -1;
      }
      if (pointing == "right") {
        x_direction = 1;
      }
      
      element = $(element);
    
      var color = element.color();
      var col = element.column();
      var row = element.row();
    
      var result = false;
    
      var x,y;
      x = col + (2 * x_direction);
      y = row + (2 * y_direction);
      first = Jewel.find(x,y);
      if (first && first.color() == color) {
        if (pointing == "up" || pointing == "down") {
          y = row + (3 * y_direction);
        }
        if (pointing == "left" || pointing == "right") {
          x = col + (3 * x_direction);
        }
        second = Jewel.find(x,y);
        result = result || second && second.color() == color;
        if (result) {
          Pattern.highlight([element, first, second]);
          Pattern.solve(element, pointing);
          return result;
        }  
      }    
    }
  },
  
  Match: {
    all: function() {
      var elements = [];
      $$('.jewel').each(function(jewel) {
        var result = Pattern.five(jewel);
        elements.push(result);
      });
      elements = elements.flatten();
      elements = elements.uniq();
      // alert("elements are: " + elements.inspect());
      return elements;
    },
  
    up: function(element) {
      return this.pattern(element, "up");
    },
  
    down: function(element) {
      return this.pattern(element, "down");
    },
  
    left: function(element) {
      return this.pattern(element, "left");
    },
  
    right: function(element) {
      return this.pattern(element, "right");
    },
  
    pattern: function(element, pointing) {
      var x_direction = 0;
      var y_direction = 0;
    
      if (pointing == "up") {
        y_direction = -1;
      }
      if (pointing == "down") {
        y_direction = 1;
      }
      if (pointing == "left") {
        x_direction = -1;
      }
      if (pointing == "right") {
        x_direction = 1;
      }
      
      element = $(element);
      
      var elements = [];
    
      var color = element.color();
      var col = element.column();
      var row = element.row();
    
      var x,y;
      x = col + (1 * x_direction);
      y = row + (1 * y_direction);
      
      var first = Jewel.find(x,y);
      
      // two in a row
      if (first && first.color() == color) {
        if (pointing == "up" || pointing == "down") {
          y = row + (2 * y_direction);
        }
        if (pointing == "left" || pointing == "right") {
          x = col + (2 * x_direction);
        }
        var second = Jewel.find(x,y);
      
        // three in a row
        if (second && second.color() == color) {
          elements.push(element);
          elements.push(first);
          elements.push(second);
          
          if (pointing == "up" || pointing == "down") {
            y = row + (3 * y_direction);
          }
          if (pointing == "left" || pointing == "right") {
            x = col + (3 * x_direction);
          }
          var third = Jewel.find(x,y);
          
          // four in a row
          if (third && third.color() == color) {
            elements.push(third);
            
            if (pointing == "up" || pointing == "down") {
              y = row + (4 * y_direction);
            }
            if (pointing == "left" || pointing == "right") {
              x = col + (4 * x_direction);
            }
            var fourth = Jewel.find(x,y);

            // five in a row
            if (fourth && fourth.color() == color) {
              elements.push(fourth);
            }
          }
        }
      }
      return elements;
    }
  }
};

var Score = {
  score: 0,
  
  update: function() {
    $('score').update(this.score);
  },
  
  add: function(value) {
    this.score = this.score + value;
    this.update();
  },
};

var Colors = {
  colors: ["red", "blue", "yellow", "purple", "orange", "green"],
  
  count: {},
  last: null,
  last_count: 0,
  
  init: function() {
    this.fresh = this.createFresh();
    
    this.colors.each(function(color) {
      Colors.count[color] = 0;
    });
  },
  
  increment: function(color) {
    this.count[color]++;
  },
  
  decrement: function(color) {
    this.count[color]--;
  },
    
  createFresh: function() {
    var fresh = [];
    var last = 0;
    while(fresh.size() < (Jewels.rows * Jewels.columns)) {
      last = last + 1;
      if (last === this.colors.size()) {
        last = 0;
      } 
      fresh.push(this.colors[last]);
    }
    return fresh;
  },
  
  generate: function() {
    if (this.fresh.size() > 0) {
      return this.generateFromFresh();
    } else {
      return this.random();
    }
  },
  
  generatePostFresh: function() {
    var min, kolor, color;
    
    var counts = [];

    for (i=0; i <= this.colors.size(); i++) {
      kolor = Colors.colors[i];
      counts.push(Colors.count[kolor]);
    }
    var index = counts.indexOf(counts.min());
    kolor = Colors.colors[index];
    
    if (this.last == index) {
      if (this.last_count < 2) {
        this.last_count = this.last_count + 1;
      } else {
        this.last = null;
        this.last_count = 0;
        
        kolor = Colors.random();
      }
    } else {
      this.last = index;
      this.last_count = 1;
    }
    return kolor;
  },
  
  generateFromFresh: function() {
    try {
      var rand, color;
    
      var x = this.fresh.size() + 1;
    
      rand = Math.floor(Math.random() * x);
    
      color = this.fresh.splice(rand-1, 1);
      return color;
    } catch(err) {
      alert(err);
    }    
  },
  
  random: function() {
    try {
      var rand, color;
    
      var count = this.colors.size();
    
      var x = count * 30;
      x = x + 1;
      rand = Math.floor(Math.random() * x) - 1;
      if (rand < 0) {
        rand = 0;
      }
      var rand2 = Math.floor(rand / 30);
      
      color = this.colors[rand2];
      return color;
    } catch(err) {
      alert(err);
    }    
  },

  each: function(callback) {
    this.colors.each(function(color) {
      callback(color);
    });
  }
};

var Jewels = {
  last: null,
  rows: 8,
  columns: 8,
  
  init: function() {
    try {
      Colors.init();
      Jewels.create();
      Score.update();
      
      Jewels.checkAllForMatches();
    } catch(z) {
      alert(z);
    }
  },
  
  create: function() {
    var width = Jewels.columns * Jewel.width;
    var height = Jewels.rows * Jewel.height;
    
    width_str = new String(width) + "px";
    height_str = new String(height) + "px";
    
    $('main').setStyle({
      "width": width_str,
      "height": height_str
    });
    $('header').setStyle({
      "height": (height - 20 + 4) + "px"
    });
    
    this.each(function(c, r) {
      var color = Colors.generate();

      jewel = Jewel.new(c, r, color);
      $('main').insert(jewel);
    });
  },
  
  each: function(callback) {
    for (r = 1; r <= Jewels.rows; r++) {
      for (c = 1; c <= Jewels.columns; c++) {
        callback(c, r);
      }
    }
  },
  
  settle: function() {
    this.each(function(c, r) {
      jewel = Jewel.find(c, r);
      if (jewel) {
        
      } else {
        Jewel.drop(c, r);
      }
    });
    this.checkAllForMatches();
  },
  
  allRows: function(col, callback) {
    var result = false;
    for (i = 1; i <= Jewels.rows; i++) {
      var jewel = Jewel.find(col, i);
      result = result || callback(jewel);
    }
    return result;
  },
  
  allColumns: function(row, callback) {
    var result = false;
    for (i = 1; i <= Jewels.columns; i++) {
      var jewel = Jewel.find(i, row);
      result = result || callback(jewel);
    }
    return result;
  },
  
  checkAllForMatches: function() {
    var result = false;
    
    result = Pattern.match();
    // alert(result.inspect());

    if (result.any()) {
      result.each(function(j) {
        Score.add(10);
        Colors.decrement(j.color());
        j.remove();
      });
      setTimeout("Jewels.settle();", 500);
    }
    
    // Pattern.all();
    return result;
  }
};

var Jewel = {
  height: 50,
  width: 50,
  
  new: function(column, row, color) {
    color = color || Colors.generate();
    var jewel = new Element('div', {
      "class": "jewel"
    });
    jewel.setStyle(Jewel.style.default());
    jewel.setStyle({
      "background": color
    });
    
    Colors.increment(color);
    
    jewel.setColumn(column);
    jewel.setRow(row);
    jewel.onclick = jewel.click;
    
    return jewel;
  },
  
  find: function(column, row) {
    return $$('.c' + column + '.r' + row).first();
  },
  
  drop: function(column, row) {
    if (row > 1) {
      for(z=row-1; z > 0; z--) {
        above = Jewel.find(column, z);
        above.setRow(z+1);
      }
    }
    var jewel = Jewel.new(column, 1);
    $('main').insert(jewel);
  },
  
  style: {
    default: function() {
      return {
        "height": new String(Jewel.height-2) + "px",
        "width": new String(Jewel.width-2) + "px"
      };
    },
    
    clicked: function() {
      return {
        "height": new String(Jewel.height-6) + "px",
        "width": new String(Jewel.width-6) + "px"
      };
    }
  },
  
  InstanceMethods: {
    click: function(element) {
      try {
        $$('.jewel').each(function(j) {
          j.removeClassName('clicked');
          j.setStyle(Jewel.style.default());
        });
      
        if (Jewels.last) {
          var last = $(Jewels.last);
          element.swapIfAdjacent(last);
          Jewels.last = null;
        } else {        
          element.setClicked();
          Jewels.last = element;
        }
      } catch(err) {
        alert(err);
      }
    },
  
    explode: Explode.single,
  
    color: function(element) {
      element = $(element);
      var color;
      color = element.getStyle("background-color");
      return color;
    },
  
    setClicked: function(element) {
      $$('.clicked').each(function(e) {
        e.removeClassName("clicked").setStyle(Jewel.style.default());
        Jewels.last = null;
      });
      element = $(element);
      element.addClassName("clicked").setStyle(Jewel.style.clicked());
    },
  
    setColor: function(element, color) {
      element = $(element);
      element.setStyle({
        "background": color
      })
    },
  
    setColorRandom: function(element) {    
      var color = Colors.generate();
      element.setColor(color);
      Jewels.checkAllForMatches();
    },
  
    move: function(element, direction) {
      element = $(element);
      var column = element.column();
      var row = element.row();
    
      if (direction == "up") {
        row--;
      }
      if (direction == "down") {
        row++;
      }
      if (direction == "left") {
        column--;
      }
      if (direction == "right") {
        column++;
      }
      var next = Jewel.find(column, row);
      element.swap(next);
    },
  
    swap: function(element, last) {
      element = $(element);
      last = $(last);
    
      var current_color = element.color();
      var last_color = last.color();
    
      last.setColor(current_color);
      element.setColor(last_color); 
    },
  
    swapIfAdjacent: function(element, last) {
      if (element.adjacent(last)) {
        element.swap(last);
        if (Jewels.checkAllForMatches().any()) {
        } else {
          last.swap(element);
        }
      } 
    },
  
    adjacent: function(element, last) {
      element = $(element);
    
      row_distance = Math.abs(element.row() - last.row());
      col_distance = Math.abs(element.column() - last.column());
    
      var same_row = row_distance === 1;
      var same_col = col_distance === 1;
    
      return (same_row ? !same_col : same_col);
    },
  
    row: function(element) {
      element = $(element);
      try {
        var top = element.getStyle("top");
        top = pixels(top);
        var row = top / Jewel.height;
      } catch(e) {
        alert(e);
      }
    
      return row+1;
    },
  
    column: function(element) {
      element = $(element);
      try {
        var left = element.getStyle("left");
        left = pixels(left);
        var column = left / Jewel.width;
      } catch(e) {
        alert("column: " + e);
      }
    
      return column+1;
    },
  
    setTop: function(element, height) {
      element = $(element);
      element.setStyle({
        "top": (height) + "px"      
      });
    },
  
    setLeft: function(element, height) {
      element = $(element);
      element.setStyle({
        "left": (height) + "px"      
      });
    },
  
    setRow: function(element, row) {
      element = $(element);

      var start = 0;
      var end = Jewel.height * (row-1);
    
      element.setTop(end);
      element.clearRowClasses();
      element.addClassName("r" + row);
    },
  
    setColumn: function(element, col) {
      element = $(element);
      element.setLeft(Jewel.width * (col-1));
      element.clearColumnClasses();
      element.addClassName("c" + col);
    },
  
    clearRowClasses: function(element) {
      for (i=1; i <= Jewels.rows; i++) {
        element.removeClassName("r" + i);
      }
    },
  
    clearColumnClasses: function(element) {
      for (i=1; i <= Jewels.columns; i++) {
        element.removeClassName("c" + i);
      }
    }    
  }
};


Element.addMethods(Jewel.InstanceMethods);
  
document.observe("dom:loaded", Jewels.init);

</script>

<style type="text/css">  

#main {
  border: 3px solid black;
  position: absolute;
  top: 10px;
  left: 200px;
}

#header {
  background-color: #aaa;
  border: 1px solid #ccc;
  padding: 10px;
  position: absolute;
  top: 10px;
  left: 10px;
  width: 150px;
}

.jewel {
  border: 1px solid white;
  cursor: pointer;
  display: inline-block;
  position: absolute;
}

.clicked {
  border: 3px solid magenta;
}

</style>


</head>
<body>

<div id="header">
<h1>Jooled</h1>

<p>Score: <span id="score"></span></p>
<!-- <p id='thingy'><a href="javascript:void(0);" onclick="alert(Object.toJSON(Colors.count)); return false;">Count colors</a></p> -->
<p><a href="#" onclick="Pattern.hint(); return false;">Hint</a></p>
  <div style="display:none;">
    <p><a href="#" onclick="Remove.all('red'); return false;">Remove all red</a></p>
    <p><a href="#" onclick="Remove.all('blue'); return false;">Remove all blue</a></p>
    <p><a href="#" onclick="Remove.all('green'); return false;">Remove all green</a></p>
    <p><a href="#" onclick="Remove.all('purple'); return false;">Remove all purple</a></p>
    <p><a href="#" onclick="Remove.all('yellow'); return false;">Remove all yellow</a></p>
    <p><a href="#" onclick="Remove.all('orange'); return false;">Remove all orange</a></p>
  </div>
</div>



<div id='main'>
</div>  
  
</div>

</body>
</html>